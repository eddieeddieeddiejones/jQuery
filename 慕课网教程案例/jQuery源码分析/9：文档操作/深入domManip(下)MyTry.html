<!doctype html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<script src="http://img.mukewang.com/down/540812440001e40e00000000.js" type="text/javascript"></script>
	<!-- // <script type="text/javascript" src="../jquery-2.1.1.js"></script> -->
	<title>domManip</title>
</head>
<body>

<button id="test1">div.innerHTML</button>
<button id="test2">$.append</button>
<button id="test3">模拟append实现script加载</button>

<div id="test"></div>

<script type="text/javascript">

$("#test3").click(function(){
	append(document.querySelectorAll("div")[0],"<script>alert("慕课网")")
})

//还原脚本
// elem = script元素
function restoreScript(elem){
	elem.removeAttribute("type")
	return elem
}

// 关闭脚本执行
// elem = script元素
function disableScript(elem){
	elem.type = (elem.getAttribute("type")!==null)+"/" + elem.type
	return elem
}

// elems = ["<script>alert('慕课网')"], context = document
function buildFragment(eles,context){
	var fragment = context.createDocumentFragment(),
	i=0,
	len = eles.length,
	ele
	for(;i<l;i++){
		ele = eles[i]
		fragment.appendChild(context.createElement("div"))
		div.innerHTML = ele
	}
	return fragment
}

// parentEles = [div#test], target = "<script>alert('慕课网')", callback = (elem)
function domManip(parentEles,target,callback){
	var l = parentEles.length
	var iNoClone = l-1
	var scripts
	var hasScripts
	if(l){
		var fragment = buildFragment([target],parentEles[0].ownerDocument)
		var first = fragment.firstChild.firstChild
		if(first){
			scripts = disableScript(first)
			hasCripts = true
			callback.call(parentEles,scripts)
		}
		//执行脚本
		if(hasScripts){
			restoreScript(scripts)
			var code = scripts.textContent.replace(/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,"")
			eval(code)
		}
	}
}

//parentEles = [div#test], target = "<script>alert('慕课网')"
function append(parentEles,target){
	return domManip([parentEles],target,function(elem){
		parentEles.appendChild(elem)
	})
}


</script>
</body>
</html